{
  "image": "mcr.microsoft.com/devcontainers/base:jammy",

  "features": {
      "ghcr.io/devcontainers/features/nix:1": {
        "multiUser": true,
        "packages": ["cachix"],
        "extraNixConfig": "experimental-features = nix-command flakes, trusted-users = root vscode"
      }
  },


  "onCreateCommand": {
    "Setup cachix": "cachix use cachix; cachix use digitallyinduced;",
    "Setup direnv": "sudo apt install direnv; echo 'eval \"$(direnv hook bash)\"' >> ~/.bashrc",
    "Set IHP BASEURL": "echo 'export IHP_BASEURL=$(if [ -n \"${CODESPACE_NAME}\" ]; then echo \"https://${CODESPACE_NAME}-8000.${GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN}\"; else echo \"http://localhost:8000\"; fi)' >> ~/.bashrc",
    "Set IHP IDE BASEURL": "echo 'export IHP_IDE_BASEURL=$(if [ -n \"${CODESPACE_NAME}\" ]; then echo \"https://${CODESPACE_NAME}-8001.${GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN}\"; else echo \"http://localhost:8001\"; fi)' >> ~/.bashrc",
    "Fix nix Permissions": "sudo apt install acl; sudo setfacl -k /tmp",
    "Allow direnv": "mkdir -p ~/.config/direnv; touch ~/.config/direnv/direnv.toml; echo \"[whitelist]\nprefix = ['/workspaces/']\" >> ~/.config/direnv/direnv.toml",
    "Prefetch": "nix build --accept-flake-config --impure github:digitallyinduced/ihp-boilerplate#devShells.x86_64-linux.default --no-link"
  },

  "containerEnv": {
    "PROJECT_DIR": "${containerWorkspaceFolder}"
  },

  "remoteUser": "vscode",

  "customizations": {
    "vscode": {
      "settings": {
        "terminal.integrated.profiles.linux": {
          "bash": {
            "path": "/bin/bash"
          }
        },
        "terminal.integrated.defaultProfile.linux": "bash"
      },
      "extensions": [
        "bbenoist.nix",
        "haskell.haskell",
        "s0kil.vscode-hsx",
        "mkhl.direnv",
        "vigoo.stylish-haskell"
      ]
    }
  }
}
